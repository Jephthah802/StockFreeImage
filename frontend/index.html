<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StockFreeImage</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --accent: #f72585;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --success: #4cc9f0;
      --warning: #f8961e;
      --danger: #e63946;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--light);
      color: var(--dark);
      line-height: 1.6;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 1rem 0;
      box-shadow: var(--box-shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      display: flex;
      align-items: center;
    }

    .logo i {
      margin-right: 10px;
      font-size: 2rem;
    }

    nav ul {
      display: flex;
      list-style: none;
    }

    nav ul li {
      margin-left: 1.5rem;
    }

    nav ul li a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      transition: var(--transition);
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
    }

    nav ul li a:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .auth-buttons {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 0.5rem 1.5rem;
      border: none;
      border-radius: var(--border-radius);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-primary {
      background-color: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background-color: #e11570;
      transform: translateY(-2px);
    }

    .btn-outline {
      background-color: transparent;
      border: 2px solid white;
      color: white;
    }

    .btn-outline:hover {
      background-color: white;
      color: var(--primary);
    }

    .hero {
      background: linear-gradient(rgba(67, 97, 238, 0.8), rgba(114, 9, 183, 0.8)), 
                  url('https://images.unsplash.com/photo-1579546929662-711aa81148cf?ixlib=rb-4.0.3&auto=format&fit=crop&w=1500&q=80');
      background-size: cover;
      background-position: center;
      color: white;
      text-align: center;
      padding: 4rem 0;
      margin-bottom: 2rem;
    }

    .hero h1 {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .hero p {
      font-size: 1.2rem;
      max-width: 600px;
      margin: 0 auto 2rem;
    }

    .search-container {
      max-width: 700px;
      margin: 0 auto;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 50px;
      font-size: 1.1rem;
      box-shadow: var(--box-shadow);
    }

    .search-btn {
      position: absolute;
      right: 5px;
      top: 5px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 0.8rem 1.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .search-btn:hover {
      background: var(--primary-dark);
    }

    .categories {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin: 2rem 0;
      flex-wrap: wrap;
    }

    .category-btn {
      background: white;
      border: 1px solid var(--light-gray);
      border-radius: 50px;
      padding: 0.7rem 1.5rem;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }

    .category-btn:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-3px);
    }

    .results-section {
      padding: 2rem 0;
    }

    .section-title {
      text-align: center;
      margin-bottom: 2rem;
      font-size: 2rem;
      color: var(--dark);
    }

    .search-results {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .image-card {
      background: white;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
    }

    .image-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .image-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .image-info {
      padding: 1rem;
    }

    .image-info h3 {
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    .image-info p {
      color: var(--gray);
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    .image-actions {
      display: flex;
      justify-content: space-between;
    }

    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--gray);
      transition: var(--transition);
      font-size: 1.1rem;
    }

    .action-btn:hover {
      color: var(--primary);
    }

    .load-more {
      text-align: center;
      margin: 2rem 0;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-control {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid var(--light-gray);
      border-radius: var(--border-radius);
      font-size: 1rem;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-footer {
      margin-top: 1.5rem;
      text-align: center;
    }

    .form-footer a {
      color: var(--primary);
      text-decoration: none;
    }

    .playlists-section {
      padding: 2rem 0;
      background: var(--light-gray);
    }

    .playlists {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .playlist-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
    }

    .playlist-card:hover {
      transform: translateY(-3px);
    }

    .playlist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .playlist-title {
      font-weight: 600;
      font-size: 1.2rem;
    }

    .playlist-images {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 5px;
    }

    .playlist-thumb {
      width: 100%;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
    }

    footer {
      background: var(--dark);
      color: white;
      padding: 3rem 0 1rem;
      margin-top: 3rem;
    }

    .footer-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .footer-section h3 {
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }

    .footer-section ul {
      list-style: none;
    }

    .footer-section ul li {
      margin-bottom: 0.5rem;
    }

    .footer-section a {
      color: #ccc;
      text-decoration: none;
      transition: var(--transition);
    }

    .footer-section a:hover {
      color: white;
    }

    .social-links {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .social-links a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      transition: var(--transition);
    }

    .social-links a:hover {
      background: var(--primary);
      transform: translateY(-3px);
    }

    .copyright {
      text-align: center;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      color: #ccc;
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }

      nav ul {
        flex-wrap: wrap;
        justify-content: center;
      }

      nav ul li {
        margin: 0.5rem;
      }

      .hero h1 {
        font-size: 2.2rem;
      }

      .search-results {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
    }

    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .mt-2 {
      margin-top: 2rem;
    }

    .mb-2 {
      margin-bottom: 2rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <div class="logo">
          <i class="fas fa-images"></i>
          <span>StockFreeImage</span>
        </div>
        <nav>
          <ul>
            <li><a href="#home">Home</a></li>
            <li><a href="#search">Search</a></li>
            <li><a href="#favorites">Favorites</a></li>
            <li><a href="#playlists">Playlists</a></li>
          </ul>
        </nav>
        <div class="auth-buttons">
          <button class="btn btn-outline" id="login-btn">Login</button>
          <button class="btn btn-primary" id="register-btn">Register</button>
          <div id="user-menu" class="hidden">
            <span id="username">User</span>
            <button class="btn btn-outline" id="logout-btn">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <section class="hero" id="home">
    <div class="container">
      <h1>Discover Amazing Images</h1>
      <p>Search through millions of high-quality images and create your own collections</p>
      <div class="search-container">
        <input type="text" class="search-input" id="search-input" placeholder="Search for images...">
        <button class="search-btn" id="search-button">
          <i class="fas fa-search"></i> Search
        </button>
      </div>
      <div class="categories">
        <button class="category-btn" data-category="people">People</button>
        <button class="category-btn" data-category="cities">Cities</button>
        <button class="category-btn" data-category="animals">Animals</button>
        <button class="category-btn" data-category="sports">Sports</button>
        <button class="category-btn" data-category="nature">Nature</button>
        <button class="category-btn" data-category="technology">Technology</button>
      </div>
    </div>
  </section>

  <section class="results-section" id="search">
    <div class="container">
      <h2 class="section-title">Search Results</h2>
      <div class="search-results" id="search-results">
      </div>
      <div class="load-more">
        <button class="btn btn-primary hidden" id="show-more-button">Load More</button>
      </div>
    </div>
  </section>

  <section class="playlists-section" id="playlists">
    <div class="container">
      <h2 class="section-title">Your Playlists</h2>
      <div class="playlists" id="playlists-container">
      </div>
      <div class="text-center mt-2">
        <button class="btn btn-primary" id="create-playlist-btn">Create New Playlist</button>
      </div>
    </div>
  </section>

  <section class="results-section" id="favorites">
    <div class="container">
      <h2 class="section-title">Your Favorites</h2>
      <div class="search-results" id="favorites-container">
      </div>
    </div>
  </section>

  <div class="modal" id="login-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Login</h2>
        <button class="close-modal">&times;</button>
      </div>
      <form id="login-form">
        <div class="form-group">
          <label for="login-email">Email</label>
          <input type="email" class="form-control" id="login-email" required autocomplete="email">
        </div>
        <div class="form-group">
          <label for="login-password">Password</label>
          <input type="password" class="form-control" id="login-password" required autocomplete="current-password">
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
        <div class="form-footer">
          <p>Don't have an account? <a href="#" id="show-register">Register</a></p>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="register-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Register</h2>
        <button class="close-modal">&times;</button>
      </div>
      <form id="register-form">
        <div class="form-group">
          <label for="register-name">Full Name</label>
          <input type="text" class="form-control" id="register-name" required autocomplete="name">
        </div>
        <div class="form-group">
          <label for="register-email">Email</label>
          <input type="email" class="form-control" id="register-email" required autocomplete="email">
        </div>
        <div class="form-group">
          <label for="register-password">Password</label>
          <input type="password" class="form-control" id="register-password" required autocomplete="new-password">
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Register</button>
        <div class="form-footer">
          <p>Already have an account? <a href="#" id="show-login">Login</a></p>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="create-playlist-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create New Playlist</h2>
        <button class="close-modal">&times;</button>
      </div>
      <form id="create-playlist-form">
        <div class="form-group">
          <label for="playlist-name">Playlist Name</label>
          <input type="text" class="form-control" id="playlist-name" required autocomplete="off">
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Create Playlist</button>
      </form>
    </div>
  </div>

  <div class="modal" id="add-to-playlist-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add to Playlist</h2>
        <button class="close-modal">&times;</button>
      </div>
      <form id="add-to-playlist-form">
        <div class="form-group">
          <label for="playlist-select">Select Playlist</label>
          <select class="form-control" id="playlist-select" required></select>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Add to Playlist</button>
      </form>
    </div>
  </div>

  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h3>ImageSearch Pro</h3>
          <p>Discover and organize beautiful images from around the world.</p>
          <div class="social-links">
            <a href="#"><i class="fab fa-facebook-f"></i></a>
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
            <a href="#"><i class="fab fa-linkedin-in"></i></a>
          </div>
        </div>
        <div class="footer-section">
          <h3>Quick Links</h3>
          <ul>
            <li><a href="#home">Home</a></li>
            <li><a href="#search">Search</a></li>
            <li><a href="#favorites">Favorites</a></li>
            <li><a href="#playlists">Playlists</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h3>Contact Us</h3>
          <ul>
            <li><i class="fas fa-envelope"></i> support@imagesearch.com</li>
            <li><i class="fas fa-phone"></i> +1 (555) 123-4567</li>
            <li><i class="fas fa-map-marker-alt"></i> 123 Image Street, Photo City</li>
          </ul>
        </div>
      </div>
      <div class="copyright">
        <p>&copy; 2025 ImageSearch Pro. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    const API_BASE = 'http://localhost:4000/api';

    let currentUser = null;
    let token = localStorage.getItem('token');
    let currentPage = 1;
    let currentQuery = '';
    let selectedImage = null;

    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userMenu = document.getElementById('user-menu');
    const usernameSpan = document.getElementById('username');
    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    const searchResults = document.getElementById('search-results');
    const showMoreButton = document.getElementById('show-more-button');
    const favoritesContainer = document.getElementById('favorites-container');
    const playlistsContainer = document.getElementById('playlists-container');
    const createPlaylistBtn = document.getElementById('create-playlist-btn');
    const categoryBtns = document.querySelectorAll('.category-btn');
    
    const loginModal = document.getElementById('login-modal');
    const registerModal = document.getElementById('register-modal');
    const createPlaylistModal = document.getElementById('create-playlist-modal');
    const addToPlaylistModal = document.getElementById('add-to-playlist-modal');
    const closeModalBtns = document.querySelectorAll('.close-modal');
    const showRegisterLink = document.getElementById('show-register');
    const showLoginLink = document.getElementById('show-login');
    
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const createPlaylistForm = document.getElementById('create-playlist-form');
    const addToPlaylistForm = document.getElementById('add-to-playlist-form');

    document.addEventListener('DOMContentLoaded', () => {
      checkAuthStatus();
      if (token) {
        loadFavorites();
        loadPlaylists();
      }
    });

    async function checkAuthStatus() {
      if (token) {
        try {
          const response = await fetch(`${API_BASE}/auth/me`, {
            headers: { 'Authorization': `Bearer ${token}` },
          });
          if (response.ok) {
            const data = await response.json();
            currentUser = { name: data.name };
            updateUIForAuth(true);
          } else {
            throw new Error('Invalid token');
          }
        } catch (error) {
          console.error('Authentication error:', error);
          localStorage.removeItem('token');
          token = null;
          updateUIForAuth(false);
        }
      } else {
        updateUIForAuth(false);
      }
    }

    function updateUIForAuth(isAuthenticated) {
      if (isAuthenticated) {
        loginBtn.classList.add('hidden');
        registerBtn.classList.add('hidden');
        userMenu.classList.remove('hidden');
        usernameSpan.textContent = currentUser.name || 'User';
      } else {
        loginBtn.classList.remove('hidden');
        registerBtn.classList.remove('hidden');
        userMenu.classList.add('hidden');
        favoritesContainer.innerHTML = '<p>Please log in to view favorites.</p>';
        playlistsContainer.innerHTML = '<p>Please log in to view playlists.</p>';
      }
    }

    loginBtn.addEventListener('click', () => {
      loginModal.style.display = 'flex';
    });

    registerBtn.addEventListener('click', () => {
      registerModal.style.display = 'flex';
    });

    showRegisterLink.addEventListener('click', (e) => {
      e.preventDefault();
      loginModal.style.display = 'none';
      registerModal.style.display = 'flex';
    });

    showLoginLink.addEventListener('click', (e) => {
      e.preventDefault();
      registerModal.style.display = 'none';
      loginModal.style.display = 'flex';
    });

    createPlaylistBtn.addEventListener('click', () => {
      if (!token) {
        alert('Please login to create playlists');
        loginModal.style.display = 'flex';
        return;
      }
      createPlaylistModal.style.display = 'flex';
    });

    closeModalBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        loginModal.style.display = 'none';
        registerModal.style.display = 'none';
        createPlaylistModal.style.display = 'none';
        addToPlaylistModal.style.display = 'none';
      });
    });

    window.addEventListener('click', (e) => {
      if (e.target === loginModal) loginModal.style.display = 'none';
      if (e.target === registerModal) registerModal.style.display = 'none';
      if (e.target === createPlaylistModal) createPlaylistModal.style.display = 'none';
      if (e.target === addToPlaylistModal) addToPlaylistModal.style.display = 'none';
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      try {
        const response = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });
        const data = await response.json();
        if (response.ok) {
          token = data.token;
          localStorage.setItem('token', token);
          localStorage.setItem('userName', data.name); // Store name for fallback
          currentUser = { name: data.name };
          updateUIForAuth(true);
          loginModal.style.display = 'none';
          loginForm.reset();
          loadFavorites();
          loadPlaylists();
          alert(`Welcome, ${data.name}!`);
        } else {
          alert(data.message || 'Login failed. Please check your credentials.');
        }
      } catch (error) {
        console.error('Login error:', error);
        alert('An error occurred during login. Please try again.');
      }
    });

    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;

      try {
        const response = await fetch(`${API_BASE}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password }),
        });
        const data = await response.json();
        if (response.ok) {
          token = data.token;
          localStorage.setItem('token', token);
          localStorage.setItem('userName', data.name); // Store name for fallback
          currentUser = { name: data.name };
          updateUIForAuth(true);
          registerModal.style.display = 'none';
          registerForm.reset();
          loadFavorites();
          loadPlaylists();
          alert(`Welcome, ${data.name}!`);
        } else {
          alert(data.message || 'Registration failed. Please try again.');
        }
      } catch (error) {
        console.error('Registration error:', error);
        alert('An error occurred during registration. Please try again.');
      }
    });

    logoutBtn.addEventListener('click', () => {
      token = null;
      localStorage.removeItem('token');
      localStorage.removeItem('userName');
      currentUser = null;
      updateUIForAuth(false);
      searchResults.innerHTML = '';
      showMoreButton.classList.add('hidden');
    });

    searchButton.addEventListener('click', performSearch);
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') performSearch();
    });

    categoryBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const category = btn.getAttribute('data-category');
        searchInput.value = category;
        performSearch();
      });
    });

    async function performSearch() {
      currentQuery = searchInput.value.trim();
      if (!currentQuery) {
        searchResults.innerHTML = '<p>Please enter a search term.</p>';
        return;
      }
      if (!token) {
        alert('Please login to search images');
        loginModal.style.display = 'flex';
        return;
      }

      currentPage = 1;
      searchResults.innerHTML = '<p>Searching...</p>';

      try {
        const response = await fetch(`${API_BASE}/images/search?query=${encodeURIComponent(currentQuery)}&page=${currentPage}`, {
          headers: { 'Authorization': `Bearer ${token}` },
        });
        const data = await response.json();
        if (response.ok) {
          displaySearchResults(data.results || []);
          showMoreButton.classList.toggle('hidden', !data.results || data.results.length === 0);
        } else {
          throw new Error(data.message || 'Search failed');
        }
      } catch (error) {
        console.error('Search error:', error);
        searchResults.innerHTML = `<p>Error searching images: ${error.message}. Please try again.</p>`;
      }
    }

    function displaySearchResults(images) {
      if (images.length === 0) {
        searchResults.innerHTML = '<p>No images found. Try a different search term.</p>';
        return;
      }

      searchResults.innerHTML = '';
      images.forEach(image => {
        const imageCard = createImageCard(image, false);
        searchResults.appendChild(imageCard);
      });
    }

    showMoreButton.addEventListener('click', async () => {
      currentPage++;
      try {
        const response = await fetch(`${API_BASE}/images/search?query=${encodeURIComponent(currentQuery)}&page=${currentPage}`, {
          headers: { 'Authorization': `Bearer ${token}` },
        });
        const data = await response.json();
        if (response.ok) {
          data.results.forEach(image => {
            const imageCard = createImageCard(image, false);
            searchResults.appendChild(imageCard);
          });
        } else {
          throw new Error(data.message || 'Failed to load more images');
        }
      } catch (error) {
        console.error('Load more error:', error);
        searchResults.innerHTML += `<p>Error loading more images: ${error.message}.</p>`;
      }
    });

    async function loadFavorites() {
      if (!token) return;

      try {
        const response = await fetch(`${API_BASE}/favorites`, {
          headers: { 'Authorization': `Bearer ${token}` },
        });
        const data = await response.json();
        if (response.ok) {
          displayFavorites(data);
        } else {
          throw new Error(data.message || 'Failed to load favorites');
        }
      } catch (error) {
        console.error('Error loading favorites:', error);
        favoritesContainer.innerHTML = `<p>Error loading favorites: ${error.message}.</p>`;
      }
    }

    function displayFavorites(favorites) {
      favoritesContainer.innerHTML = '';
      if (favorites.length === 0) {
        favoritesContainer.innerHTML = '<p>No favorites yet. Start adding some!</p>';
        return;
      }

      favorites.forEach(favorite => {
        const imageCard = createImageCard(favorite, true);
        favoritesContainer.appendChild(imageCard);
      });
    }

    async function addToFavorites(image) {
      if (!token) {
        alert('Please login to add favorites');
        loginModal.style.display = 'flex';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/favorites`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
          },
          body: JSON.stringify({
            id: image.id,
            url: image.urls.small,
            alt_description: image.alt_description,
            user: { name: image.user.name },
            links: { html: image.links.html },
          }),
        });
        const data = await response.json();
        if (response.ok) {
          alert('Added to favorites!');
          loadFavorites();
        } else {
          throw new Error(data.message || 'Failed to add favorite');
        }
      } catch (error) {
        console.error('Error adding favorite:', error);
        alert(`Failed to add to favorites: ${error.message}`);
      }
    }

    async function removeFromFavorites(imageId) {
      try {
        const response = await fetch(`${API_BASE}/favorites/${imageId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` },
        });
        const data = await response.json();
        if (response.ok) {
          alert('Removed from favorites!');
          loadFavorites();
        } else {
          throw new Error(data.message || 'Failed to remove favorite');
        }
      } catch (error) {
        console.error('Error removing favorite:', error);
        alert(`Failed to remove from favorites: ${error.message}`);
      }
    }

    async function loadPlaylists() {
      if (!token) return;

      try {
        const response = await fetch(`${API_BASE}/playlists`, {
          headers: { 'Authorization': `Bearer ${token}` },
        });
        const data = await response.json();
        if (response.ok) {
          displayPlaylists(data);
        } else {
          throw new Error(data.message || 'Failed to load playlists');
        }
      } catch (error) {
        console.error('Error loading playlists:', error);
        playlistsContainer.innerHTML = `<p>Error loading playlists: ${error.message}.</p>`;
      }
    }

    function displayPlaylists(playlists) {
      playlistsContainer.innerHTML = '';
      if (playlists.length === 0) {
        playlistsContainer.innerHTML = '<p>No playlists yet. Create your first one!</p>';
        return;
      }

      playlists.forEach(playlist => {
        const playlistCard = createPlaylistCard(playlist);
        playlistsContainer.appendChild(playlistCard);
      });
    }

    createPlaylistForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('playlist-name').value;

      try {
        const response = await fetch(`${API_BASE}/playlists`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
          },
          body: JSON.stringify({ name }),
        });
        const data = await response.json();
        if (response.ok) {
          alert('Playlist created!');
          createPlaylistModal.style.display = 'none';
          createPlaylistForm.reset();
          loadPlaylists();
        } else {
          throw new Error(data.message || 'Failed to create playlist');
        }
      } catch (error) {
        console.error('Error creating playlist:', error);
        alert(`Failed to create playlist: ${error.message}`);
      }
    });

    async function addImageToPlaylist(playlistId, image) {
      try {
        const response = await fetch(`${API_BASE}/playlists/${playlistId}/images`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
          },
          body: JSON.stringify({
            id: image.id,
            url: image.urls.small,
            alt_description: image.alt_description,
            user: { name: image.user.name },
            links: { html: image.links.html },
          }),
        });
        const data = await response.json();
        if (response.ok) {
          alert('Image added to playlist!');
          loadPlaylists();
          addToPlaylistModal.style.display = 'none';
        } else {
          throw new Error(data.message || 'Failed to add image to playlist');
        }
      } catch (error) {
        console.error('Error adding image to playlist:', error);
        alert(`Failed to add image to playlist: ${error.message}`);
      }
    }

    async function deletePlaylist(playlistId) {
      if (!confirm('Are you sure you want to delete this playlist?')) return;

      try {
        const response = await fetch(`${API_BASE}/playlists/${playlistId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` },
        });
        const data = await response.json();
        if (response.ok) {
          alert('Playlist deleted!');
          loadPlaylists();
        } else {
          throw new Error(data.message || 'Failed to delete playlist');
        }
      } catch (error) {
        console.error('Error deleting playlist:', error);
        alert(`Failed to delete playlist: ${error.message}`);
      }
    }

    async function showPlaylistSelection(image) {
      selectedImage = image;
      if (!token) {
        alert('Please login to add to playlists');
        loginModal.style.display = 'flex';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/playlists`, {
          headers: { 'Authorization': `Bearer ${token}` },
        });
        const data = await response.json();
        if (response.ok) {
          const select = document.getElementById('playlist-select');
          select.innerHTML = '';
          if (data.length === 0) {
            select.innerHTML = '<option value="">No playlists available</option>';
          } else {
            data.forEach(playlist => {
              const option = document.createElement('option');
              option.value = playlist._id;
              option.textContent = playlist.name;
              select.appendChild(option);
            });
          }
          addToPlaylistModal.style.display = 'flex';
        } else {
          throw new Error(data.message || 'Failed to fetch playlists');
        }
      } catch (error) {
        console.error('Error fetching playlists:', error);
        alert(`Error fetching playlists: ${error.message}`);
      }
    }

    addToPlaylistForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const playlistId = document.getElementById('playlist-select').value;
      if (!playlistId) {
        alert('Please create a playlist first');
        return;
      }
      await addImageToPlaylist(playlistId, selectedImage);
    });

    function createImageCard(image, isFavorite) {
      const card = document.createElement('div');
      card.className = 'image-card';
      
      card.innerHTML = `
        <img src="${image.urls?.small || image.imageUrl || image.url}" alt="${image.alt_description || 'Image'}">
        <div class="image-info">
          <h3>${(image.alt_description || 'Untitled').substring(0, 30)}</h3>
          <p>By ${image.user?.name || image.photographer || 'Unknown'}</p>
          <div class="image-actions">
            <button class="action-btn favorite-btn ${isFavorite ? 'active' : ''}">
              <i class="fas fa-heart"></i>
            </button>
            <button class="action-btn add-to-playlist-btn">
              <i class="fas fa-folder-plus"></i>
            </button>
            <a href="${image.links?.html || image.unsplashLink || '#'}" target="_blank" class="action-btn">
              <i class="fas fa-external-link-alt"></i>
            </a>
          </div>
        </div>
      `;

      const favoriteBtn = card.querySelector('.favorite-btn');
      favoriteBtn.addEventListener('click', () => {
        if (isFavorite) {
          removeFromFavorites(image._id || image.id);
        } else {
          addToFavorites(image);
        }
      });

      const addToPlaylistBtn = card.querySelector('.add-to-playlist-btn');
      addToPlaylistBtn.addEventListener('click', () => {
        showPlaylistSelection(image);
      });

      return card;
    }

    function createPlaylistCard(playlist) {
      const card = document.createElement('div');
      card.className = 'playlist-card';
      
      const thumbnails = playlist.images?.slice(0, 3) || [];
      
      card.innerHTML = `
        <div class="playlist-header">
          <div class="playlist-title">${playlist.name}</div>
          <button class="action-btn delete-playlist-btn">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <div class="playlist-images">
          ${thumbnails.map(img => 
            `<img src="${img.imageUrl || img.url}" class="playlist-thumb" alt="Thumbnail">`
          ).join('')}
          ${thumbnails.length === 0 ? '<p>No images yet</p>' : ''}
        </div>
        <p class="mt-2">${playlist.images?.length || 0} images</p>
      `;

      const deleteBtn = card.querySelector('.delete-playlist-btn');
      deleteBtn.addEventListener('click', () => {
        deletePlaylist(playlist._id);
      });

      return card;
    }
  </script>
</body>
</html>